1203 之前的登录 现在做调整修改
// 未登录状态下加入购物车
let self = this;

      wx.getStorage({
        key:'cartArray',
        encrypt: true, // 若开启加密存储，setStorage 和 getStorage 需要同时声明 encrypt 的值为 true
        success(res) {
          // console.log(res.data,'data中餐品数据');
          // 先将本地存储里的数据存起来
          const cartList = res.data;    //整个页面数组 主要是为了那个属性
          let pataData = self.data;      // 获取当前商品数据
          // pataData.quantity = self.data.number;
          // pataData.foodsId = self.data.id;         //foodsId 为了数字num
          // pataData.foodsProductId = self.data.guigeId;
          pataData.isCombo = self.data.info.isCombo;
          // console.log(pataData,'当前商品数据当前商品数据pataData');

          // 判断数组是否存在该商品
          let isExist = false;

          // 已有商品，数量累加
          cartList.forEach(cart => {
            // cart.foodsProductId + cart.attribute
            let temp1 = JSON.stringify(cart.attribute)
            // cart.foodsProductId === pataData.foodsProductId && cart.attribute == pataData.attribute
            if(cart.foodsProductId === pataData.foodsProductId && JSON.stringify(cart.attributes) == JSON.stringify(pataData.attributes)) {
              isExist = true;
              // console.log(cart,'goods/ccartid');
              cart.quantity += self.data.quantity;
              // 更新本地存储
              wx.setStorage({
                data:cartList,
                key:'cartArray',
                encrypt: true, // 若开启加密存储，setStorage 和 getStorage 需要同时声明 encrypt 的值为 true
              })
            }
          })

          // 如果不在数组中，将商品直接push进去
          if(!isExist) {
            // pataData.quantity = self.data.number;
            // pataData.foodsId = self.data.id;         //foodsId 为了数字num
            // pataData.foodsProductId = self.data.guigeId;
            pataData.isCombo = self.data.info.isCombo;
            cartList.push(pataData);

            // 更新本地存储
            wx.setStorage({
              data:cartList,
              key:'cartArray',
              encrypt: true, // 若开启加密存储，setStorage 和 getStorage 需要同时声明 encrypt 的值为 true
            })
            // console.log(cartList,'cartList');
          }
        },
        fail(){
        let pataData = self.data;                   //这是一个对象里面的info是部分数据
        // pataData.quantity = self.data.number;     //加入购物车单个的数量
        //foodsId foodsProductId
        // pataData.foodsId = self.data.id;
        // pataData.foodsProductId = self.data.guigeId;
        pataData.isCombo = self.data.info.isCombo;
        let cartList = [];
        cartList.push(pataData);

        // 本地存储 cartArray==cartList==res.data
        wx.setStorage({
          data:cartList,
          key:'cartArray',    //cartArray==cartList==res.data
          encrypt: true,     //开启加密存储
        })
        // console.log(cartList,'failcartListfailcartListfailcartList');
        },
        complete() {
          // 清除本地缓存的数据
          var timestamp = Date.parse(new Date());
          var expiration = timestamp + 3600000; //缓存60分钟
          // var expiration = timestamp + 1800000; //缓存30分钟
          var data_expiration = wx.getStorageSync("data_expiration");
          if (data_expiration) {
            if (timestamp > data_expiration) {
              wx.clearStorageSync()
              // console.log('已经清除缓存内容！');
              wx.setStorageSync("data_expiration", expiration)
              }
            } else {
                wx.setStorageSync("data_expiration", expiration)
              }
        }
      })

      // 加入购物车提醒
      wx.showToast({
        title: '加入购物车成功',
        icon:'success',
        duration:3000
      })
      // 跳转页面
      setTimeout(
        function(){ //注意function这里不能缺少
          wx.switchTab({
            url: "../../pages/catalog/catalog"
          })
        },1000)

// 获取缓存的过期时间
let clearTime = wx.getStorageSync("clearTime");
// console.log(clearTime,'clearTime');
// 判断 clearTime 是否存在
if (clearTime) {
if (new Date().getTime() > clearTime) {
// 已过期，清除缓存
wx.clearStorageSync();
// 清除后执行更新数据及新的过期时间
wx.setStorageSync("clearTime", new Date().getTime() + 259200000);
}// 不存在就存入过期时间即可
}else {
wx.setStorageSync("clearTime", new Date().getTime() + 259200000);
}
}
},100)

newCart.js
else {
// 未登录状态下购物车里的数据
wx.getStorage({
key: 'cartArray',
encrypt: true, // 加密存储
success(res) {
const cartList = res.data; //缓存里面的数据
// console.log(cartList,'缓存中的购物车数据');
let newTotal = cartList.map(item => item.quantity);
let price = cartList.map(item => item.quantity \* item.price);
let total = 0;
let totalPrice = 0;
for (let i = 0; i < cartList.length; i++) {
total += newTotal[i];
totalPrice += price[i];
}
that.setData({
cartList: res.data, //购物车列表数组
totalPrice: totalPrice,
})

        },
        // fail() {}
      })
    }

// 减少商品数量
// cutNumber: function (e) {
// let that = this;
// let currentNumber = e.target.dataset.index;
// let cartGood = this.data.cartList[currentNumber];
// let minPrice = cartGood.price
// let productInfo = {
// foodsProductId: cartGood.foodsProductId,
// attributes: cartGood.attributes
// }

// function removeCache() {
// wx.getStorage({
// key: 'cartArray',
// encrypt: true,
// success (res) {
// let pataData = res.data
// pataData.forEach((val,index,arr) => {
// // console.log(productInfo,'product');
// if(productInfo.foodsProductId == val.foodsProductId && JSON.stringify(productInfo.attributes) == JSON.stringify(val.attributes)) {
// // console.log(val,'valvalval');
// if(val.quantity - 1 === 0) {
// arr.splice(index,1) //删除列表为 0 的列表项
// wx.showToast({
// title: '删除成功!'
// });
// } else {
// val.quantity = val.quantity - 1;
// }
// }
// cartGood.quantity = val.quantity
// // console.log(pataData,'pataData');
// })
// // 更新本地存储
// wx.setStorage({
// data:pataData,
// key:'cartArray',
// encrypt: true, // 开启加密存储
// })
// that.setData({
// cartList:pataData,
// totalPrice: (that.data.totalPrice - minPrice) < 0 ? 0 :that.data.totalPrice - minPrice,
// });
// },

// })
// // console.log(that.data.cartList,'123123123');
// }
// // 判断用户是否登录
// if(wx.getStorageSync('userId')){
// if (cartGood.quantity - 1 === 0) {
// util.request(api.DeleteCart, {
// productInfo: [productInfo]
// }, "POST").then(res => {
// // console.log(res,'用户登录点击删除');
// if (res.errno == 0) {
// wx.showToast({
// title: '删除成功'
// });
// this.getCart();
// }
// }, null);
// } else {
// let minPrice = cartGood.price
// cartGood.quantity = cartGood.quantity - 1 > 1 ? cartGood.quantity - 1 : 1;
// this.setData({
// cartList: this.data.cartList,
// totalPrice: this.data.totalPrice - minPrice,
// });
// }
// } else {
// removeCache()
// }
// this.updateCart(cartGood);
// },

// // 加
// addNumber: function (e) {
// let that = this;
// // console.log("e", e);
// let currentNumber = e.target.dataset.index;
// let cartGood = this.data.cartList[currentNumber];
// let miPrice = cartGood.price
// cartGood.quantity = cartGood.quantity + 1; //修改后的数量
// this.setData({
// cartList: this.data.cartList,
// totalPrice: this.data.totalPrice + miPrice,
// });

// wx.getStorage({
// key: 'cartArray',
// encrypt:true,
// success(res) {
// const pataData = res.data;
// pataData.forEach((val, index) => {
// if (cartGood.foodsProductId === val.foodsProductId && JSON.stringify(cartGood.attributes) == JSON.stringify(val.attributes)) {
// val.number = cartGood.quantity
// val.quantity = cartGood.quantity;
// }
// })
// wx.setStorage({
// key: 'cartArray',
// data: pataData,
// encrypt:true,
// success(res) {}
// })
// }
// })
// this.updateCart(cartGood);
// },

1205
// 未登录状态下百货页面购物车里的数据
wx.getStorage({
key:'productArray',
encrypt: true, // 加密存储
success(res){
const cartList = res.data; //缓存里面的数据
// console.log(cartList,'缓存中的 shangping 购物车数据');
let newTotal = cartList.map(item => item.quantity);
let price = cartList.map(item => item.quantity\*item.price);
let total = 0; let totalPrice = 0;
for ( let i = 0; i<cartList.length;i++) {
total += newTotal[i];
totalPrice += price[i];
}
that.setData({
cartList:res.data, //购物车列表数组
totalPrice:totalPrice,
})

    },
    // fail(){}

})

// 减少物品
cutNumber: function (e) {
let currentNumber = e.target.dataset.index;
let cartGood = this.data.cartList[currentNumber];
let minPrice = cartGood.price
let that = this;
function removeCache() {
wx.getStorage({
key: 'productArray',
encrypt: true,
success (res) {
let pataData = res.data
pataData.forEach((val,index,arr) => {
if(cartGood.goodsProductId === val.goodsProductId) {
// console.log(val,'valvalval');
if(val.quantity - 1 === 0) {
arr.splice(index,1) //删除列表为 0 的列表项
wx.showToast({
title: '删除成功!'
});
} else {
val.quantity = val.quantity - 1;
}
}
cartGood.quantity = val.quantity
// pataData.quantity = cartGood.quantity
// console.log(pataData,'pata');  
 })
// 更新本地存储
wx.setStorage({
data:pataData,
key:'productArray',
encrypt: true, // 开启加密存储
})
that.setData({
cartList: pataData,
// totalPrice: that.data.totalPrice - minPrice,
totalPrice: (that.data.totalPrice - minPrice) < 0 ? 0 :that.data.totalPrice - minPrice,
});
// console.log(that.data.totalPrice,'that.data.totalPrice');
},

        })
    }
    if(wx.getStorageSync('userId')){
      if (cartGood.quantity - 1 === 0) {
        util.request(api.GoodsDeleteCart, {
          userId: wx.getStorageSync('userId'),
          productIds: [cartGood.goodsProductId]
        }, "POST").then(res => {
          // console.log(res);
          if (res.errno == 0) {
            wx.showToast({
              title: '删除成功'
            });
            this.getCart();
          }
        },null);
      } else {
      let minPrice = cartGood.price
      cartGood.quantity = cartGood.quantity - 1 > 1 ? cartGood.quantity - 1 : 1;
        this.setData({
          cartList: this.data.cartList,
          totalPrice: this.data.totalPrice - minPrice,
        });
      }
    } else {
    removeCache();
    }

    this.updateCart(cartGood);

},
// 增加物品
addNumber: function (e) {
let that = this;
// console.log(e);
let currentNumber = e.target.dataset.index;
let cartGood = this.data.cartList[currentNumber];
let miPrice = cartGood.price
cartGood.quantity = cartGood.quantity + 1;
this.setData({
cartList: this.data.cartList,
totalPrice: this.data.totalPrice + miPrice,
});
wx.getStorage({
key: 'productArray',
encrypt:true,
success(res) {
const pataData = res.data;
pataData.forEach((val, index) => {
if (cartGood.goodsProductId === val.goodsProductId) {
val.quantity = cartGood.quantity;
}
})
wx.setStorage({
key: 'productArray',
data: pataData,
encrypt:true,
success(res) {}
})
}
})
this.updateCart(cartGood);
},
