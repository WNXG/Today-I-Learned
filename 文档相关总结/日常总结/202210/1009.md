1009 15:59
我的人生该跑的 800m 都跑完了
昨天也是今天凌晨熬到一两点 算是把小程序扫码识别桌号部分跑通
下午删删改改页面 搞了很久 算是搞完了 来这个公司的第一个任务点 虽然中途也有很多其他的 bug
但是这个来说 是对我职业生涯第一个最大的挑战
不熟悉小程序开发的我 直接上手项目 索性遇到人愿意帮助
那就总结一下 扫码识别桌号的改变吧
首先
小程序没有状态管理 这个小程序也没有借助其他状态管理仓库
首先需要在 app.js 中定义了一个全局变量 globalData：{deskNum:''}
然后在需要修改的页面添加相应的功能
主要是点单（catalog)页面和结算（newCart）页面 ui 做了修改
html 页面的修改

```

 <view class="top">
    <view class="textarea">{{ name }}</view>
    <view class="search-card">
    <image class="image1" src="/static/indexImage/search.png"></image>
    <input type="text" placeholder="请输入菜品" bindinput="searchValue" />
    </view>
    <view wx:if="{{deskNum}}" class="optionbox optionbox-tangshi" bindtap="switchTab">
      <view class="optionbox-tangshi-num">
        桌号：<text>{{ deskNum }}</text>
      </view>
      <view class="tangshi selected" id="tangshi">堂食</view>
      <!-- <view class="tangshi {{index == 0 ? 'selected' : ''}}" id="tangshi">堂食</view>
      <view class="ziqu {{index == 1 ? 'selected' : ''}}" id="ziqu">自取</view> -->
    </view>
    <view wx:else class="optionbox optionbox-ziqu" bindtap="switchTab">
      <view class="tangshi selected" id="ziqu">自取</view>
    </view>
  </view>

```

html

```
/* 输入框 */
.search-card {
  display: flex;
  justify-content: end;
  align-items: center;
  /* position: absolute; */
  top: 180rpx;
  left: 10rpx;
  position: absolute;
  width: 400rpx;
  height: 64rpx;
  padding-left: 20rpx;
  border-radius: 32rpx;
  background-color: #fff;
}

/* .search-card input {
 position: absolute;
  width: 450rpx;
  height: 64rpx;
  padding-left: 20rpx;
  border-radius: 32rpx;
  background-color: #fff;
} */
.image1 {
  position: relative;

  width: 50rpx;
  height: 50rpx;
}

/* 堂食及自取 */
.optionbox-tangshi {
  width: 300rpx;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background-color: #c49b6d26;
}

.optionbox-tangshi-num {
  color: #000;
  padding-left: 30rpx;
}
/* 桌号字体 */
.optionbox-tangshi-num text {
  color: #c29666;
  font-size: 16px;
}

.optionbox-ziqu {
  display: flex;
  justify-content: flex-end;
  padding-right: 20rpx;
}
```

css

```
 onLoad: function (options) {
    // 获取桌号
    console.log('options',options)
    // 如果有桌号，则存桌号
    if (options.desk) {
      app.globalData.deskNum = options.desk
    }
  },

    onShow: function () {
    //判断食堂食还是自取
    this.setData({
      index: app.globalData.changeIndex,
      deskNum: app.globalData.deskNum
    });
  },

  // 输入框搜索模块的实现
  searchValue(e) {
    let val = e.detail.value
    let data = []
    if (val !== '') {
      data = this.data.cacheCategory.filter(item => {
        return item.category.name.includes(val)
      })
    } else {
      data = this.data.cacheCategory
    }
    this.setData({
      category: data
    })
    console.log(this.data.category);
  }
```

js

此处只列举一个

关于购物车支付页面
添加了一个 picker 组件 用于取餐时间的设置 此处直接参考的官方文档设计

1010
今天发工资啦 1k 前端第一桶金 支付宝存了 700 微信 300 微信用来吃饭哈哈
然后 今天主要还是在修改小程序 主要在搞他发布上线 很多问题
然后 了解到 develop 开发环境 和 prod 生产环境 的区别 算是搞明白了

1011
今天主要在发布小程序 1.1 版本 各种问题 还没发布成功 然后 二维码申请那块也有问题存在 希望明天能解决

1012
今天基于昨天发布微信小程序版本不通过的问题 微信审核不允许进入小程序直接授权用户登录 对此需要进行调整

1013 没有谁的生活会一直完美 满怀希望就能所向披靡 丞哥 bless me
没有谁会一直靠得住 我只能靠自己 实现达到自己想要的一切
小程序 全局路由拦截 那块卡了几天 发布上线也在卡着 今天的新任务是下拉刷新更新订单页 没有谁有义务一直帮我做什么 靠自己嗷 加油 我可以的

现在是下午三点 实现了
需要添加的下拉刷新 静态的购物车 简单判断 若没有则提示空空如也 订单页也添加了提示
问题： 小程序路由拦截那块 目前还不能正确实现不登录加入购物车等功能 控制台还是会报错

需要添加地址图标呜呜呜 又给自己找了事情
基本完成

听了黑马 pink 的直播 我觉得我拿 14k 也没得问题 性能优化 项目规模 封装通用组件方便他人合作

1014
在用户没有登录的情况下 前端进行存储数据 对数据进行增删改操作
下拉刷新获取最新订单做了一层判断 不会导致请求两次数据

在 app.js 里定义全局变量 shopping: []
需要在这里对数据进行增删改操作

```
//添加到购物车
  addToCart: function () {
    console.log(this.data);
    if (wx.getStorageSync('userId')) {
      util.request(api.AddCart + '?userId=' + wx.getStorageSync('userId'), {
        foodsId: this.data.info.id,
        quantity: this.data.number,
        foodsProductId: this.data.guigeId,
        attributes: this.data.attribute,
        isCombo: this.data.info.isCombo
      }, "POST")
      .then(function (res) {
        // console.log("添加", res);
        if (res.errno == 0) {
          wx.showToast({
            title: '添加成功'
          });
        } else {
          wx.showToast({
            title: res.errmsg,
            icon: "none"
          });
        }
        setTimeout(function () {
          wx.navigateBack({
            delta: 1,
          })
        }, 500)
      }, res => {
        // console.log(res);
      });
    } else {
      console.log('存入前端缓存');
      console.log(this.globalData.shopping);
    }

  },

```

下拉刷新用户订单数据

```
beforeOnRefresh: function() {
     //导航条加载动画
     wx.showNavigationBarLoading()
     //loading 提示框
     wx.showLoading({
       title: 'Loading...',
     })
  },
  closeOnRefresh: function() {
    wx.hideLoading();
    wx.hideNavigationBarLoading();
    //停止下拉刷新
    wx.stopPullDownRefresh();
  },
  /**
   * 页面相关事件处理函数--监听用户下拉动作
   */
  onPullDownRefresh:function(){
    this.beforeOnRefresh()
    if (this.data.current === 0) {
      this.getOrderInfo();
    } else {
      this.getGoodsOrderInfo();
    }
  },

```

还是需要 setTimeout(函数,2000)来调用结束的回调函数 setTimeout 里面 this 指向问题 ...

```
/**
  * 页面相关事件处理函数--监听用户下拉动作
  */
 onPullDownRefresh:function(){
   let that = this;
   this.beforeOnRefresh()
   if (this.data.current === 0) {
     this.getOrderInfo();
    //  this.closeOnRefresh();
    setTimeout(function(){
      that.closeOnRefresh()
    }, 1000)
   } else {
     this.getGoodsOrderInfo();
    setTimeout(function(){
      that.closeOnRefresh()
    }, 1000)
   }
 },
```

1017
支付接口对接 支付接口基本修改完 我觉得很烦真的 好难
ui 设计图修改
未登录状态下正常加入购物车

1.未登录 结算时需要判断是否登录 没登录跳转登录页

2.加入购物车 加入哪些数据？ 怎么样算添加成功
菜品名 数量 单价 图片

1018 配置小程序点击跳转遇到的问题：

```
navigateTo路由跳转方式可以实现历史回退
其他路由的一些简单介绍：

wx.navigateTo() 带历史回退,不能跳转到tabbar页面

wx.redirectTo() 不保留历史，跳转到另一个页面，不能返回到上一页面
//相当于vue中的路由跳转方式this.$router.replace()

wx.switchTab() 只跳转到tabBar页面，不带回退

wx.reLaunch() 即能跳转到tabBar页面，也能跳转到非tabBar页面，不带历史回退
```

退款接口调整&小程序页面优化

1019
今天写了一天 没登录状态加入购物车 还没完全实现

```
  // 获取用户登录信息
  // getUserInfo:function () {
  //   // 判断当前用户是否微信授权
  //   if (app.globalData.userInfo.avatar == null) {
  //     wx.showModal({
  //       content: '您还未授权',
  //       confirmText: '去授权',
  //       success(res) {
  //         if (res.confirm) {
  //           wx.showToast({
  //             title: '请登录后添加购物车',
  //             icon: "none",
  //             duration: 2000
  //           })
  //         }
  //       }
  //     })
  //     return
  //   }
  // },

  //添加到购物车
  // addToCart: function () {
  //   util.request(api.AddCart + '?userId=' + wx.getStorageSync('userId'), {
  //       foodsId: this.data.info.id,
  //       quantity: this.data.number,
  //       foodsProductId: this.data.guigeId,
  //       attributes: this.data.attribute,
  //       isCombo: this.data.info.isCombo
  //     }, "POST")
  //     .then(function (res) {
  //       // console.log("添加", res);
  //       if (res.errno == 0) {
  //         wx.showToast({
  //           title: '添加成功'
  //         });
  //       } else {
  //         wx.showToast({
  //           title: res.errmsg,
  //           icon: "none"
  //         });
  //       }
  //       setTimeout(function () {
  //         wx.navigateBack({
  //           delta: 1,
  //         })
  //       }, 500)
  //     }, res => {
  //       // console.log(res);
  //     });
  // },
```

```
//总价格
            // let toPrice = cartArray.map((item,index) => {
            //   return item.minPrice * item.quantity
            // })
            // // console.log(toPrice,'多件商品总价格');
            // let totPrice = 0
            // for ( let i = 0; i<newTotal.length;i++) {
            //   totPrice += toPrice[i];
            // }
            // console.log(totPrice,'多件商品总价格1111111111');

```

```
newCart.js
 onShow: function () {
    this.getCart();
    // console.log(app.globalData.changeIndex);

  // const self = this;
  // // 未登录状态下购物车里的数据
  // wx.getStorage({
  //   key:'cartInfo',
  //   encrypt: true, // 若开启加密存储，setStorage 和 getStorage 需要同时声明 encrypt 的值为 true
  //   success(res){
  //     const cartList = res.data;                 //缓存里面的数据
  //     console.log(cartList,'缓存中的购物车数据');
  //     let newTotal =  cartList.map(item => item.quantity);
  //     let price =  cartList.map(item => item.quantity*item.minPrice);
  //     let total = 0; let totalPrice = 0;
  //     for ( let i = 0; i<cartList.length;i++) {
  //           total += newTotal[i];
  //           totalPrice +=  price[i];
  //     }
  //     self.setData({
  //       // cartList:cartList,
  //       cartList:res.data,
  //       name:cartList.name,
  //       minPrice:cartList.minPrice,
  //       totalPrice:totalPrice,
  //     })

  //   },
  //   fail(){

  //   }
  // })
  },

```

1021
软件项目管理实验报告提上日程
没搞完的项目得继续搞完 然后提交什么的
21 号挺忙的其实 代码没搞什么
早上拍毕业生信息采集照
下午两点开了个简短的会议 两周一次 biweekly 说一说你这两周的感觉什么的
然后四点周会总结 还演示了微信小程序代码
然后 关于微信小程序 目前有个小想法
能不能把未登录缓存封装一个函数 需要调用的地方去调用
然后就是 需要在用户登录之后 push 进去缓存中的数据 还有就是需要设置缓存过期时间
那么就得确保那些需要展示的变量名一致 才可以尽量少的进行修改

1022
商品那块 UI 也需要做一个调整 但是优先级不是很高
还是需要先解决逻辑

先不想封装的问题 先解决页面问题 是在不行就是重复代码过得 这个那就没办法

没有用的代码 我感觉我在造一堆没什么用的东西

```
// 所有商品总数量
          //  let newTotal =  cartList.map(item => item.quantity)
          //   // console.log(newTotal,'总数量数组');
          //   let total = 0;
          //   for ( let i = 0; i<newTotal.length;i++) {
          //     total += newTotal[i];
          //   }
          //   wx.setStorage({
          //     data:total,
          //     key:'alltotal'
          //   })

```

遇到点问题
准备在本地缓存中存两个东西 一个 list 数组 存全部信息 为了能够遍历出规格信息
一个 info 数组 到时候好操作加减
然后现在同时添加两个之后 不能一次加入多个数据 不知道哪的问题

然后关于加入购物车 里面删减数据的 bug 这个调整真的难受 ctmd
还有就是用户登录之后得先获取一遍本地缓存中的数据 然后还需要发一次请求 获取服务器里面的数据
今天脑袋不清楚了 明天再写吧

1023
第一步先实现静态展示出来的数据没问题 再进行优化修改
食品那块静态数据没什么问题了 两个问题 登录之后没获取缓存数据 已经 缓存过期时间不知道设置对不对
第二个问题 加减操作 总价没改变

1024
提交之前删除没有用的代码 一些 consloe util 里面的两个没用的文件

做了哪些修改： 1.不登录状态下 点单页面和百货页面正常加入购物车
缓存数据再 storage 里面
建立了两个数组 cartArray 和 productArray 两个 key 值 存在 storage 里面
到目前为止 10 月 24 日 已经实现静态的 也不是完全静态 有两个小 bug 还需要调整
先 wx.setStorage 进行存储 然后在 getStorage 取数据 然后一步步修改 然后就是 UI 那块选好了什么的还需要微调一下 到时候看情况吧
catalog 页面数字获取

```
 getCart() {
    const self = this;
    // 判断用户是否登录
    if (wx.getStorageSync('userId')) {
      util.request(api.CartIndex + '?userId=' + wx.getStorageSync('userId')).then(res => {
        this.setData({
          goodsNum: res.data.cartTotal.foodsCount,
          amount: res.data.cartTotal.foodsAmount,
          cartList: res.data.cartList
        })
      //   console.log("购物车", res);
      })
    }else{
      wx.getStorage(({
        key:'cartArray',
        // encrypt: true,
        success(res){
          const cartList = res.data;                 //缓存里面的数据
          let newTotal =  cartList.map(item => item.number);
          let price =  cartList.map(item => item.number*item.price);
          // console.log(newTotal,'总数量数组');
          let total = 0; let totalPrice = 0;
          for ( let i = 0; i<cartList.length;i++) {
            total += newTotal[i];
            totalPrice +=  price[i];
          }
        // const total = res.data;                 //缓存里面的数据
        // console.log(totalPrice,'price');

        self.setData({
          goodsNum:total,   //购物车数量
          amount:totalPrice,      //总金额
        })
        }
      }))
    }

  },
```

goods 商品详情页实现不登录状态加入购物车

```
//添加到购物车
  addToCart: function () {
    // console.log(this.data);
    // 判断用户是否登录
    if (wx.getStorageSync('userId')) {
      // wx.getStorage({
      //   key:'cartArray',
      //   encrypt: true,
      //   success(res) {

      //   }
      // })
      console.log(this.data,'data11111111111111111');

      util.request(api.AddCart + '?userId=' + wx.getStorageSync('userId'), {
        foodsId: this.data.info.id,        //菜品名
        quantity: this.data.number,       //数量
        foodsProductId: this.data.guigeId,
        attributes: this.data.attribute,
        isCombo: this.data.info.isCombo
      }, "POST")
      .then(function (res) {
        // console.log("添加", res);
        if (res.errno == 0) {
          wx.showToast({
            title: '添加成功'
          });
        } else {
          wx.showToast({
            title: res.errmsg,
            icon: "none"
          });
        }
        setTimeout(function () {
          wx.navigateBack({
            delta: 1,
          })
        }, 500)
      }, res => {
        // console.log(res);
      });
    } else {

// 未登录状态下加入购物车
      let self = this;
      wx.getStorage({
        key:'cartArray',
        // encrypt: true, // 若开启加密存储，setStorage 和 getStorage 需要同时声明 encrypt 的值为 true
        success(res) {
          console.log(res,'data中餐品数据');
          // 先将本地存储里的数据存起来
          const cartList = res.data;    //整个页面数组 主要是为了那个属性
          const cartInfo = res.data.info;//单个商品具体数据为了加减操作的实现
          // 获取当前商品数据
          let partData = self.data;
          let pataInfo = self.data.info;             //info数据{}

          // 判断数组是否存在该商品
          let isExist = false;

          // 已有商品，total累加
          cartList.forEach(cart => {
            if(cart.id === partData.id) {
              isExist = true;
              // cart.total += self.data.info.count;
              cart.total += self.data.number;
              // 本地存储
              wx.setStorage({
                data:cartList,
                key:'cartArray',
                // encrypt: true, // 若开启加密存储，setStorage 和 getStorage 需要同时声明 encrypt 的值为 true
              })
              // 本地存储 cartInfo == cartInfo = =res.data.info
              // wx.setStorage({
              // key:'cartInfo',
              // data:cartInfo,
              // // encrypt: true,     //开启加密存储
              // })
            }
          })

          // 如果不在数组中，将商品直接push进去
          if(!isExist) {
            partData.quantity = self.data.number;

            cartList.push(partData);
            // cartInfo.push(pataInfo);

            // 本地存储
            wx.setStorage({
              data:cartList,
              key:'cartArray',
              // encrypt: true, // 若开启加密存储，setStorage 和 getStorage 需要同时声明 encrypt 的值为 true
            })

        // 本地存储 cartInfo == cartInfo = =res.data.info
        // wx.setStorage({
        //   key:'cartInfo',
        //   data:cartInfo,
        //   // encrypt: true,     //开启加密存储
        // })
          }
        },
        fail(){
        let pataData = self.data;                   //这是一个对象里面的info是部分数据
        let pataInfo = self.data.info;             //info数据{}

        let cartInfo = [];
        cartInfo.push(pataInfo);                  //单个商品的info具体信息

        pataData.quantity = self.data.number;     //加入购物车单个的数量

        let cartList = [];
        cartList.push(pataData);

        // 本地存储 cartArray==cartList==res.data
        wx.setStorage({
          data:cartList,
          key:'cartArray',    //cartArray==cartList==res.data
          // encrypt: true,     //开启加密存储
        })

        // 本地存储 cartInfo == cartInfo = =res.data.info
        wx.setStorage({
          key:'cartInfo',
          data:cartInfo,
          // encrypt: true,     //开启加密存储

        })
        }
      })

      // 加入购物车提醒
      wx.showToast({
        title: '加入购物车成功',
        icon:'success',
        duration:3000
      })
      // 跳转页面
      setTimeout(
        function(){ //注意function这里不能缺少
          wx.switchTab({
            url: "../../pages/catalog/catalog"
          })
        },1000)





// 获取缓存的过期时间
      let clearTime = wx.getStorageSync("clearTime");
      console.log(clearTime,'clearTime');
// 判断clearTime是否存在
      if (clearTime) {
    if (new Date().getTime() > clearTime) {
        // 已过期，清除缓存
        wx.clearStorageSync();
        // 清除后执行更新数据及新的过期时间
        wx.setStorageSync("clearTime", new Date().getTime() + 259200000);
    }
}
// 不存在就存入过期时间即可
else {
    wx.setStorageSync("clearTime", new Date().getTime() + 259200000);
}
  }


},
```

```
// 增加物品
  addNumber: function (e) {
    // console.log(e);
    let currentNumber = e.target.dataset.index;
    console.log(currentNumber,'currentNumbercurrentNumbercurrentNumber');
    let cartGood = this.data.cartList[currentNumber];
    console.log(cartGood,'cartGoodcartGoodcartGood');
    let miPrice = cartGood.price
    cartGood.quantity = cartGood.quantity + 1;
    console.log(miPrice,'miPricemiPricemiPrice');
    this.setData({
      cartList: this.data.cartList,
      totalPrice: this.data.totalPrice+miPrice,
    });
    this.updateCart(cartGood);
  },
```

```
      // 合并两个数组，缓存中的数据和数据库里的数据
      //   function mergeArr(pataData, list) { //arr目标数组 arr1要合并的数组 return会合并后的数组
      //       if(pataData.length==0){
      //           return [];
      //       }
      //       let arr3 = [];
      //       pataData.map((item, index) => {
      //           arr3.push(Object.assign(item,list[index]));
      //       })
      //       return arr3;
      //   }
      // let Array = mergeArr(pataData,list);

```

      现在是16:53分
      基本实现加减操作改变总价 但是减完之后 数据没清空得做调整
      然后 也能登录之后显示出来了 catalog页面那个价格做下调整就好

```
 function removeDp (arr1, arr2) {
        let arr = arr1.concat(arr2)
        let obj = {}
        let newArray = arr.reduce((pre, cur) => {
          if (!obj[cur.id]) {
            obj[cur.id] = true
            pre.push(cur)
          }
          return pre
        }, [])
        console.log(newArray)
      }

      let cartarray =  removeDp(pataData,list)
```

ES6 forEach 用法

```
var myArray=[
        {id:1,name:"a"},
        {id:2,name:"b"},
        {id:3,name:"c"},
        {id:4,name:"d"},
        ]
myArray.forEach((item,index)=>{
    console.log(item.id);
        //1,2,3,4,5
})
```

forEach 和 for 循环的区别？

缓存

```
// 获取本地存储的数据
    const cates =wx.getStorageSync('cates');
    if(!cates){
      // 不存在 发送请求获取数据
      this.getCategoryList();
    }else{
      // 有旧的数据
      // 判断有没有过期
      // 定义过期时间 五分钟
      if(Date.now() - cates.time > 1000 * 60 *5){
        this.getCategoryList();
      }else{
       // 直接进行处理后渲染页面
      }
    }

```

//获取购物车数据
// getCart() {
// let that = this;
// if (wx.getStorageSync('userId')) {
// util.request(api.CartIndex + '?userId=' + wx.getStorageSync('userId')).then(function (res) {
// // console.log(res,'登录状态下的购物车数据');
// let list = res.data.cartList; //登录状态下数据库里的购物车数据
// let amount = res.data.cartTotal.foodsAmount; //登录状态下数据库里的金额总和
// let pataData = [];
// // 获取本地存储的数据
// const cates =wx.getStorage({key:'cartArray'});
// if(!cates){
// // 不存在 发送请求获取数据
// console.log('没缓存走这里');
// this.getCart();
// that.setData({
// cartList: list,
// totalPrice: amount,
// })
// }else{
// // 有旧的数据
// // 判断有没有过期
// // 定义过期时间 五分钟
// if(Date.now() - cates.time > 1000 * 60 *5){
// this.getCart();
// }else{
// // 直接进行处理后渲染页面
// wx.getStorage({
// key: 'cartArray',
// // encrypt: true, // 加密存储
// success(res) {
// pataData = res.data
// //缓存里面数据库的总价计算
// let newTotal = pataData.map(item => item.quantity);
// let price = pataData.map(item => item.quantity \* item.price);
// let total = 0;
// let totPrice = 0;
// for (let i = 0; i < pataData.length; i++) {
// total += newTotal[i];
// totPrice += price[i];
// }
// //缓存里面数据库的总价计算

// // let cartarray = pataData.concat(list) //合并缓存数据和数据库里的数据

// // 把 id 值存为 key, value 是每一项对象值
// const map = new Map();
// pataData.forEach((index, item) => {
// map.set(pataData[item].id, index)
// })

// removeDp(list, pataData)

// function removeDp(arr1, arr2) {
// let arr = arr1.concat(arr2)
// console.log(arr, 'arr111');
// let newArray = arr.reduce((pre, cur, index, arr) => {
// // console.log(pre,cur,index,arr);
// // console.log(cur.foodsId,'123123');
// // cur.foodsId == arr2[index].id ? cur.quantity += arr2.quantity : cur.quantity
// if (cur.foodsId) {
// pre.push(cur)
// pre.forEach((item, index) => {
// // console.log(item.foodsId,'555');
// if (map.has(item.foodsId)) {
// item.quantity += map.get(item.foodsId).quantity
// map.delete(item.foodsId)
// }
// })
// }
// if (cur.id) {
// // if(pre.foodsId !== cur.id) pre.push(cur)
// for (let value of map.values()) {
// list.push(value)
// that.updateCart(list);
// }
// // map.clear()
// // wx.removeStorageSync('cartArray')
// pataData.forEach((item,index) => {
// for (let key of map.keys()) {
// console.log(key,'kkkkkkkkkkkk');
// }
// })
// }
// return pre
// }, [])
// console.log(list, 'listlllll')
// }

// that.setData({
// // cartList:pataData ? Array : list,
// cartList: list,
// totalPrice: totPrice ? totPrice + amount : amount,
// })

// }
// })

// }
// }
// }, res => {
// this.updateCart(cartList);
// })
// } else {
// // 未登录状态下购物车里的数据
// wx.getStorage({
// key: 'cartArray',
// // encrypt: true, // 加密存储
// success(res) {
// const cartList = res.data; //缓存里面的数据
// // console.log(cartList,'缓存中的购物车数据');
// let newTotal = cartList.map(item => item.quantity);
// let price = cartList.map(item => item.quantity \* item.price);
// let total = 0;
// let totalPrice = 0;
// for (let i = 0; i < cartList.length; i++) {
// total += newTotal[i];
// totalPrice += price[i];
// }
// that.setData({
// cartList: res.data, //购物车列表数组
// totalPrice: totalPrice,
// })

// },
// fail() {

// }
// })
// }

// },

```
 // 获取本地存储的数据
    // const cates =wx.getStorage({key:'cartArray'});
    // if(!cates){
    //   // 不存在 发送请求获取数据
    //   console.log('没缓存走这里');
    //   this.getCart();
    //   that.setData({
    //     cartList: list,
    //     totalPrice: amount,
    //   })
    // }else{
    //   // 有旧的数据
    //   // 判断有没有过期
    //   // 定义过期时间 五分钟
    //   if(Date.now() - cates.time > 1000 * 60 *5){
    //     this.getCart();
    //   }else{
    //    // 直接进行处理后渲染页面
    //    wx.getStorage({
    //     key: 'cartArray',
    //     // encrypt: true, // 加密存储
    //     success(res) {
    //       pataData = res.data
    //       //缓存里面数据库的总价计算
    //       let newTotal = pataData.map(item => item.quantity);
    //       let price = pataData.map(item => item.quantity * item.price);
    //       let total = 0;
    //       let totPrice = 0;
    //       for (let i = 0; i < pataData.length; i++) {
    //         total += newTotal[i];
    //         totPrice += price[i];
    //       }
    //       //缓存里面数据库的总价计算

    //       // let cartarray = pataData.concat(list)         //合并缓存数据和数据库里的数据

    //       // 把id值存为key, value是每一项对象值
    //       const map = new Map();
    //       pataData.forEach((index, item) => {
    //         map.set(pataData[item].id, index)
    //       })

    //       removeDp(list, pataData)

    //       function removeDp(arr1, arr2) {
    //         let arr = arr1.concat(arr2)
    //         console.log(arr, 'arr111');
    //         let newArray = arr.reduce((pre, cur, index, arr) => {
    //           // console.log(pre,cur,index,arr);
    //           // console.log(cur.foodsId,'123123');
    //           // cur.foodsId == arr2[index].id ? cur.quantity += arr2.quantity : cur.quantity
    //           if (cur.foodsId) {
    //             pre.push(cur)
    //             pre.forEach((item, index) => {
    //               // console.log(item.foodsId,'555');
    //               if (map.has(item.foodsId)) {
    //                 item.quantity += map.get(item.foodsId).quantity
    //                 map.delete(item.foodsId)
    //               }
    //             })
    //           }
    //           if (cur.id) {
    //             // if(pre.foodsId !== cur.id) pre.push(cur)
    //             for (let value of map.values()) {
    //               list.push(value)
    //               that.updateCart(list);
    //             }
    //             // map.clear()
    //             // wx.removeStorageSync('cartArray')
    //             pataData.forEach((item,index) => {
    //               for (let key of map.keys()) {
    //                 console.log(key,'kkkkkkkkkkkk');
    //               }
    //             })
    //           }
    //           return pre
    //         }, [])
    //         console.log(list, 'listlllll')
    //       }



    //       that.setData({
    //         // cartList:pataData ? Array : list,
    //         cartList: list,
    //         totalPrice: totPrice ? totPrice + amount : amount,
    //       })


    //     }
    //   })

    //   }
    // }


```

10.25 21:59 原本的 数据库减 1 操作

// 减少商品数量
cutNumber: function (e) {
let that = this;
// console.log("eeeeeeeeeeeeeeeeee", e)
let currentNumber = e.target.dataset.index;
let cartGood = this.data.cartList[currentNumber];
let productInfo = {
foodsProductId: cartGood.foodsProductId,
attributes: cartGood.attributes
}
// console.log(productInfo,'productInfoproductInfo');

    if (cartGood.quantity - 1 === 0) {
      util.request(api.DeleteCart, {
        productInfo: [productInfo]
      }, "POST").then(res => {
        // console.log(res);
        if (res.errno == 0) {
          wx.showToast({
            title: '删除成功'
          });
          this.getCart();
        }
      }, null);
    } else {
      let minPrice = cartGood.price
      // console.log(cartGood.quantity ,'cartGood.quantity cartGood.quantity ');
      cartGood.quantity = cartGood.quantity - 1 > 1 ? cartGood.quantity - 1 : 1;
      // console.log(cartGood.quantity ,'cartGood.quantity11 ');
      this.setData({
        cartList: this.data.cartList,
        totalPrice: this.data.totalPrice - minPrice,
      });

      wx.getStorage({
        key: 'cartArray',
        // encrypt:true,
        success(res) {
          const pataData = res.data;
          console.log(pataData, 'pataData----');
          pataData.forEach((val, index) => {
            if (cartGood.id === pataData[index].id) {
              pataData[index].number = cartGood.quantity
              pataData[index].quantity = cartGood.quantity;
              if(cartGood.quantity - 1 === 0) {
                pataData.splice(index,1)
              }
            }
          // console.log(index,'pataData[index]pataData[index]');

          })

          let cartList = [];
          cartList = pataData;
          wx.setStorage({
            key: 'cartArray',
            data: cartList,
            success(res) {
              console.log(cartList,'hhhhjkkkkkk');

            },
            complete(res) {
              // this.updateCart(cartList);
            }
          })
        },

      })
      // console.log(cartGood,'gggggggggggggggggg');
      this.updateCart(cartGood);
    }

},

```
// 减少商品数量
  cutNumber: function (e) {
    let that = this;
    // console.log("eeeeeeeeeeeeeeeeee", e)
    let currentNumber = e.target.dataset.index;
    let cartGood = this.data.cartList[currentNumber];
    let productInfo = {
      foodsProductId: cartGood.foodsProductId,
      attributes: cartGood.attributes
    }
    if (cartGood.quantity === 0) {
      console.log('请求');
      util.request(api.DeleteCart, {
        productInfo: [productInfo]
      }, "POST").then(res => {
        console.log(res,'rrrrrrrrr');
        if (res.errno == 0) {
          wx.showToast({
            title: '删除成功'
          });
          this.getCart();
        }
      }, null);
    } else {
      let minPrice = cartGood.price
      cartGood.quantity = cartGood.quantity - 1 > 1 ? cartGood.quantity - 1 : 1;
      console.log(this.data.cartList);
      this.setData({
        cartList: this.data.cartList,
        totalPrice: this.data.totalPrice - minPrice,
      });
      console.log('删除');
    }
    wx.getStorage({
      key: 'cartArray',
      // encrypt:true,
      success(res) {
        const pataData = res.data;
        pataData.forEach((val, index) => {
          if (cartGood.id === val.id) {
            val.number = cartGood.quantity
            val.quantity = cartGood.quantity;
            console.log(val);
            if (val.quantity === 1) {
              console.log(val);
              console.log('shanchu');
              val.splice(index , 1)
            }
      if ( pataData[index].id - 1 === 0) {
        util.request(api.DeleteCart, {
        productInfo: [productInfo]
        }, "POST").then(res => {
          console.log(res,res);
        if (res.errno == 0) {
        wx.showToast({
        title: '删除成功'
        });
       that.getCart();
        }
      }, null);
      } else {
        let minPrice = cartGood.price
        console.log(cartGood.quantity ,'cartGood.quantity cartGood.quantity ');
        cartGood.quantity = cartGood.quantity - 1 > 1 ? cartGood.quantity - 1 : 1;
        console.log(cartGood.quantity ,'cartGood.quantity11 ');
       that.setData({
          cartList: that.data.cartList,
          totalPrice: that.data.totalPrice - minPrice,
        });
        }
      }
    })

        let cartList = [];
        cartList = pataData;
        wx.setStorage({
          key: 'cartArray',
          data: cartList,
          success(res) {
            console.log(cartList, 'hhhhjkkkkkk');

          },
          complete(res) {
            // this.updateCart(cartList);
          }
        })
      },

    })
    // console.log(cartGood,'gggggggggggggggggg');
    this.updateCart(cartGood);
    // }
  },

```

2022/10/26 14:40

```
  // 减少商品数量
  cutNumber: function (e) {
    let that = this;
    // console.log("eeeeeeeeeeeeeeeeee", e)
    let currentNumber = e.target.dataset.index;
    let cartGood = this.data.cartList[currentNumber];
    let productInfo = {
      foodsProductId: cartGood.foodsProductId,
      attributes: cartGood.attributes
    }
    console.log(productInfo,'productInfoproductInfo');
    if (cartGood.quantity === 0) {
      console.log('请求');
      util.request(api.DeleteCart, {
        productInfo: [productInfo]
      }, "POST").then(res => {
        console.log(res,'rrrrrrrrr');
        if (res.errno == 0) {
          wx.showToast({
            title: '删除成功'
          });
          this.getCart();
        }
      }, null);
    } else {
      let minPrice = cartGood.price
      cartGood.quantity = cartGood.quantity - 1 > 1 ? cartGood.quantity - 1 : 1;
      console.log(this.data.cartList);
      this.setData({
        cartList: this.data.cartList,
        totalPrice: this.data.totalPrice - minPrice,
      });
      console.log('删除');
    }
    wx.getStorage({
      key: 'cartArray',
      // encrypt:true,
      success(res) {
        const pataData = res.data;
        pataData.forEach((val, index) => {
          if (cartGood.id === val.id) {
            val.number = cartGood.quantity
            val.quantity = cartGood.quantity;
            console.log(val);
            if (val.quantity === 1) {
              console.log(val);
              console.log('shanchu');
              val.splice(index , 1)
            }
      if ( pataData[index].id - 1 === 0) {
        util.request(api.DeleteCart, {
        productInfo: [productInfo]
        }, "POST").then(res => {
          console.log(res,res);
        if (res.errno == 0) {
        wx.showToast({
        title: '删除成功'
        });
       that.getCart();
        }
      }, null);
      } else {
        let minPrice = cartGood.price
        console.log(cartGood.quantity ,'cartGood.quantity cartGood.quantity ');
        cartGood.quantity = cartGood.quantity - 1 > 1 ? cartGood.quantity - 1 : 1;
        console.log(cartGood.quantity ,'cartGood.quantity11 ');
       that.setData({
          cartList: that.data.cartList,
          totalPrice: that.data.totalPrice - minPrice,
        });
        }
      }
    })

        let cartList = [];
        cartList = pataData;
        wx.setStorage({
          key: 'cartArray',
          data: cartList,
          success(res) {
            console.log(cartList, 'hhhhjkkkkkk');

          },
          complete(res) {
            // this.updateCart(cartList);
          }
        })
      },

    })
    // console.log(cartGood,'gggggggggggggggggg');
    this.updateCart(cartGood);
    // }
  },
```

if(val.quantity - 1 === 0 ) {
console.log(val,'valvalvlalv');
console.log('删除删除删除');
// console.log(arr);
// arr.splice(index,1)
}else {
console.log(val,'valvalvalval');
console.log(cartGood.quantity,'cartGood.quantity');
val.quantity = val.quantity--;

if (cur.foodsId) {
pre.push(cur)
pre.forEach((item, index) => {
if (map.has(item.foodsId)) {
item.quantity += map.get(item.foodsId).quantity
map.delete(item.foodsId)
}
})
}
if (cur.id) {
// if(pre.foodsId !== cur.id) pre.push(cur)
for (let value of map.values()) {
list.push(value)
that.updateCart(list);
}
map.clear()
// ???????????????????????? 这里确实需要清除缓存数据 但是这个方法会清掉所有 所以肯定有问题。
//如果直接使用这个方法退出之后 缓存里的数据就没了
// wx.removeStorageSync('cartArray')
}

```
 let newArray = arr.reduce((pre, cur, index, arr) => {
                console.log('输出');
                console.log(pre);
                console.log(cur);
                console.log(index);
                console.log(arr);
                console.log('--------------------');
                console.log(arr[index].foodsId,'ceshi',cur.foodsId);

                if(arr[index].foodsId == cur.id) {
                  console.log(arr[index].foodsId,'在这里改变个数',cur.foodsId);
                } else {
                  //没有就放入数组
                  pre.push(cur)
                }
                return pre
              }, [])
```

去重 重新写

```
 removeDp(list, pataData)    //合并两个缓存数据和数据库数组

            function removeDp(arr1, arr2) {
              let arr = arr1.concat(arr2)   //直接合并数组
              // console.log(arr, 'allarrlist');
              let newa = [];
             arr.forEach((val,index,array) => {
              //  console.log(val,index,array,'aaaaaaaaaarrrrrrr');
              // if(val.foodsId !== array[index].foodsId) {
              //   newa.push(val)
              // }
              for(let i = 1 ;i<arr.length ; i++) {
                if(val.foodsId === array[i].foodsId) {
              console.log(array[i].foodsId,'array')
                  val.quantity = val.quantity + map.get(array[i].foodsId).quantity;
                  // map.clear()
                }
                else {
                  // list.push(val)
                  pataData.splice(i,1)

                }
              }
             })
              console.log(list, 'listlllll')
            }
```

wx.getStorage({
key: 'cartArray',
success (res) {
let pataData = res.data
pataData.forEach((val,index,arr) => {
let minPrice = val.price
if(productInfo.foodsProductId == val.foodsProductId) {
if(val.quantity - 1 === 0) {
arr.splice(index,1)
} else {
val.quantity = val.quantity - 1;
}
}

cartGood.quantity = val.quantity
that.setData({
cartList: that.data.cartList,
totalPrice: that.data.totalPrice - minPrice,
});

pataData.quantity = cartGood.quantity
// 更新本地存储
wx.setStorage({
data:pataData,
key:'cartArray',
// encrypt: true, // 开启加密存储
})
})

},
complete() {
that.onLoad()
}

})

正确的本地存储减法操作

```

 wx.getStorage({
        key: 'cartArray',
        success (res) {
        let pataData = res.data
        // console.log(pataData,'cutNumber/cartArray/pataData')
        // productInfo.foodsProductId == pataData.foodsProductId
        pataData.forEach((val,index,arr) => {
            let minPrice = val.price
            // cartGood.quantity = cartGood.quantity - 1 > 1 ? cartGood.quantity - 1 : 1;
            // console.log(that.data.cartList);
            // val.quantity = val.quantity - 1 > 1 ? val.quantity - 1 :  0;
            if(productInfo.foodsProductId == val.foodsProductId) {
              // console.log(index,'iiiiiiiii');
              if(val.quantity - 1 === 0) {
                // console.log(val,index,arr,'-------------');
                arr.splice(index,1)
                // console.log(arr,'arrarrarr');
                // that.onLoad();
                wx.showToast({
                  title: '删除成功'
                });
              } else {
                val.quantity = val.quantity - 1;
              }
            }

            cartGood.quantity = val.quantity
            // console.log(cartGood,'减一之后的cartGood.quantity');
          that.setData({
          cartList: that.data.cartList,
          totalPrice: that.data.totalPrice - minPrice,
        });
        // console.log('删');
        pataData.quantity = cartGood.quantity
        // console.log(pataData,'删除之后的缓存列表');
             // 更新本地存储
        wx.setStorage({
          data:pataData,
          key:'cartArray',
          // encrypt: true, // 开启加密存储
        })
    })
  },
        fail(res) {

        },
        complete() {
          that.onLoad()
        }

      })
```

虽然错误 仍然正确

```
 for(let i = 0;i <= list.length ; i++) {
          for(let j = 0 ; j < pataData.length ; j++) {
            console.log(list[i].foodsId,pataData[j].id,'--',i,j);
            if(list[i].foodsId === pataData[j].foodsIdid) {
              console.log(j,'uppppppppppppppppppppppppppppppp');
              list[i].quantity += pataData[j].quantity
              console.log(list,'list');
              // that.updateCart(list)
              // pataData.splice(j,1)
               // 更新本地存储
              // wx.setStorage({
              //   data:pataData,
              //   key:'cartArray',
              //   // encrypt: true, // 开启加密存储
              // })
              // break;
            } else {
              list.push(pataData[j])
              pataData.splice(j,1)
              console.log(list,'listelse');
              // break;
            }
          }
        }
```

```
    // for(let i = 0; i< list.length ; i++) {
        //   pataData.forEach( (val,index) => {
        //     console.log(list[i].quantity,'=====',val.quantity);
        //     if(list[i].foodsId === val.foodsId) {
        //         // list[i].quantity = list[i].quantity + val.quantity;
        //         let q = list[i].quantity + val.quantity
        //         // console.log(q,'qqq');
        //         if( q !== list[i].quantity) {
        //         // pataData.splice(index,1)
        //         }
        //          // 更新本地存储
        // wx.setStorage({
        //     data:pataData,
        //     key:'cartArray',
        //    // encrypt: true, // 开启加密存储
        // })
        //     } else{
        //       list.push(val)
        //     }
        //   })
        // }
```

1027
凌晨
两个购物车的数字角标问题都解决了
购物车还有的问题就是数据传输不到数据库

```

  // 获取百货页购物车信息
  getCart() {
    let that = this;
    if (wx.getStorageSync('userId')){
    util.request(api.GoodsCartIndex + '?userId=' + wx.getStorageSync('userId')).then(res => {
      this.setData({
        cartList: res.data.cartList,
        totalPrice: res.data.cartTotal.goodsAmount,
      })
    //   console.log("购物车", res);
    })
    } else {
      // 未登录状态下百货页面购物车里的数据
  wx.getStorage({
    key:'productArray',
    // encrypt: true, // 加密存储
    success(res){
      const cartList = res.data;                 //缓存里面的数据
      // console.log(cartList,'缓存中的shangping购物车数据');
      let newTotal =  cartList.map(item => item.quantity);
      let price =  cartList.map(item => item.quantity*item.price);
      let total = 0; let totalPrice = 0;
      for ( let i = 0; i<cartList.length;i++) {
            total += newTotal[i];
            totalPrice +=  price[i];
      }
      that.setData({
        cartList:res.data,       //购物车列表数组
        totalPrice:totalPrice,
      })

    },
    // fail(){}
  })
    }
  },

```

bug:
登录之后合并完 若不删除缓存中的数组对象 会导致减一操作是加上对应的对象的个数
合并之后 如果不传到数据库 那等于白合并了 刷新或者退出页面之后 如果缓存里的数组对象已经清空那在进入页面只有数据库的数据 缓存的数据推不倒数据库 支付页面也没有对应的数据 catalog 页面也没有

{

      // foodsId: val.foodsId,        //菜品名
      // quantity:val.quantity,       //数量
      // foodsProductId: val.guigeId,
      // attributes: val.attribute,    //规格
      // isCombo: val.isCombo

}

重要别删 在重写 说不定会回退

```

wx.getStorage({
          key: 'cartArray',
          // encrypt: true, // 加密存储
          success(res) {
            pataData = res.data
            pataData.userId = userId;
let newlist = JSON.parse(JSON.stringify(pataData));//深拷贝
            console.log(newlist,'newlist取缓存取缓存取缓存');
            //缓存里面数据库的总价计算
            let newTotal = pataData.map(item => item.quantity);
            let price = pataData.map(item => item.quantity * item.price);
            let total = 0;
            let totPrice = 0;
            for (let i = 0; i < pataData.length; i++) {
              total += newTotal[i];
              totPrice += price[i];
            }
            //缓存里面数据库的总价计算

            // let cartarray = pataData.concat(list)         //合并缓存数据和数据库里的数据

            // 把id值存为key, value是每一项对象值
            // const map = new Map();
            // pataData.forEach((index, item) => {
            //   map.set(pataData[item].id, index)
            // })


            pataData.forEach((val,index) => {
              if(lmap.has(val.id)) {
                let j = lmap.get(val.id)    //数据库中下标索引值
                list[j].quantity += val.quantity
                // if(j){
                pataData.splice(index,1)
                // }
                // 更新本地存储
                wx.setStorage({
                  data:pataData,
                  key:'cartArray',
                  // encrypt: true, // 开启加密存储
                })
                // console.log(pataData,'pataData');
              } else {
                // val.userId = userId;
                list.push(val)
                lmap.set(val.id,list.length - 1)
                // console.log(lmap,'lmaplmmmmmmmmm');
              }
            })
            // console.log(lmap,'lmap');
            // console.log(pataData,'pata----缓存');
            // console.log(list,'list-数据库数据');

            // console.log(newlist,'newlistnewlist');

var newObj = util.deepClone(list)//深拷贝副本
// console.log(newObj,'nnnnnnnnnnnnnnnn');
// console.log(newlist,'newlist');

            that.setData({
              // cartList:pataData ? Array : list,
              cartList: list,
              totalPrice: totPrice ? totPrice + amount : amount,
              newArray:newlist,
            })
// that.batchUpdate()

            console.log(list,'listlistlist');
            console.log(that.data.newArray,'newArray');


          },
          fail(res) {
            that.setData({
              // cartList: res.data.cartList,
              // totalPrice: res.data.cartTotal.foodsAmount,
              cartList: list,
              totalPrice: amount
            })
          },
          complete(res) {

            that.updateCart(list)
          }
        })
```

未登录状态下加入购物车
wx.getStorage({
key:'cartArray',
// encrypt: true, // 若开启加密存储，setStorage 和 getStorage 需要同时声明 encrypt 的值为 true
success(res) {
// console.log(res.data,'data 中餐品数据');
// 先将本地存储里的数据存起来
const cartList = res.data; //整个页面数组 主要是为了那个属性
let pataData = self.data; // 获取当前商品数据
pataData.quantity = self.data.number;
pataData.foodsId = self.data.id; //foodsId 为了数字 num
pataData.foodsProductId = self.data.guigeId;  
 pataData.isCombo = self.data.info.isCombo;

          console.log(cartList,'cartListcartListcartList');

          // 判断数组是否存在该商品
          let isExist = false;

          // 已有商品，数量累加
          cartList.forEach(cart => {
            if(cart.id === pataData.id) {
              isExist = true;
              // console.log(cart.id,'goods/ccartid');
              cart.quantity += self.data.number;
              // 更新本地存储
              wx.setStorage({
                data:cartList,
                key:'cartArray',
                // encrypt: true, // 若开启加密存储，setStorage 和 getStorage 需要同时声明 encrypt 的值为 true
              })
            }
          })

          // 如果不在数组中，将商品直接push进去
          if(!isExist) {
            pataData.quantity = self.data.number;
            pataData.foodsId = self.data.id;         //foodsId 为了数字num
            pataData.foodsProductId = self.data.guigeId;
            pataData.isCombo = self.data.info.isCombo;
            cartList.push(pataData);

            // 更新本地存储
            wx.setStorage({
              data:cartList,
              key:'cartArray',
              // encrypt: true, // 若开启加密存储，setStorage 和 getStorage 需要同时声明 encrypt 的值为 true
            })
          }
        },
        fail(){
        let pataData = self.data;                   //这是一个对象里面的info是部分数据
        pataData.quantity = self.data.number;     //加入购物车单个的数量
        //foodsId foodsProductId
        pataData.foodsId = self.data.id;
        pataData.foodsProductId = self.data.guigeId;
        pataData.isCombo = self.data.info.isCombo;
        let cartList = [];
        cartList.push(pataData);

        // 本地存储 cartArray==cartList==res.data
        wx.setStorage({
          data:cartList,
          key:'cartArray',    //cartArray==cartList==res.data
          // encrypt: true,     //开启加密存储
        })
        // console.log(cartList,'failcartListfailcartListfailcartList');
        },
        complete() {
          // 清除本地缓存的数据
          var timestamp = Date.parse(new Date());
          var expiration = timestamp + 3600000; //缓存60分钟
          // var expiration = timestamp + 1800000; //缓存30分钟
          var data_expiration = wx.getStorageSync("data_expiration");
          if (data_expiration) {
            if (timestamp > data_expiration) {
              wx.clearStorageSync()
              console.log('已经清除缓存内容！！！！！！！！！');
              wx.setStorageSync("data_expiration", expiration)
              }
            } else {
                wx.setStorageSync("data_expiration", expiration)
              }
        }
      })

1030
困死
购物车搞到现在
九点还有银行考试 呜呜呜
