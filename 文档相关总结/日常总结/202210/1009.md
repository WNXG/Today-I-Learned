1009 15:59
我的人生该跑的 800m 都跑完了
昨天也是今天凌晨熬到一两点 算是把小程序扫码识别桌号部分跑通
下午删删改改页面 搞了很久 算是搞完了 来这个公司的第一个任务点 虽然中途也有很多其他的 bug
但是这个来说 是对我职业生涯第一个最大的挑战
不熟悉小程序开发的我 直接上手项目 索性遇到人愿意帮助
那就总结一下 扫码识别桌号的改变吧
首先
小程序没有状态管理 这个小程序也没有借助其他状态管理仓库
首先需要在 app.js 中定义了一个全局变量 globalData：{deskNum:''}
然后在需要修改的页面添加相应的功能
主要是点单（catalog)页面和结算（newCart）页面 ui 做了修改
html 页面的修改

```

 <view class="top">
    <view class="textarea">{{ name }}</view>
    <view class="search-card">
    <image class="image1" src="/static/indexImage/search.png"></image>
    <input type="text" placeholder="请输入菜品" bindinput="searchValue" />
    </view>
    <view wx:if="{{deskNum}}" class="optionbox optionbox-tangshi" bindtap="switchTab">
      <view class="optionbox-tangshi-num">
        桌号：<text>{{ deskNum }}</text>
      </view>
      <view class="tangshi selected" id="tangshi">堂食</view>
      <!-- <view class="tangshi {{index == 0 ? 'selected' : ''}}" id="tangshi">堂食</view>
      <view class="ziqu {{index == 1 ? 'selected' : ''}}" id="ziqu">自取</view> -->
    </view>
    <view wx:else class="optionbox optionbox-ziqu" bindtap="switchTab">
      <view class="tangshi selected" id="ziqu">自取</view>
    </view>
  </view>

```

html

```
/* 输入框 */
.search-card {
  display: flex;
  justify-content: end;
  align-items: center;
  /* position: absolute; */
  top: 180rpx;
  left: 10rpx;
  position: absolute;
  width: 400rpx;
  height: 64rpx;
  padding-left: 20rpx;
  border-radius: 32rpx;
  background-color: #fff;
}

/* .search-card input {
 position: absolute;
  width: 450rpx;
  height: 64rpx;
  padding-left: 20rpx;
  border-radius: 32rpx;
  background-color: #fff;
} */
.image1 {
  position: relative;

  width: 50rpx;
  height: 50rpx;
}

/* 堂食及自取 */
.optionbox-tangshi {
  width: 300rpx;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background-color: #c49b6d26;
}

.optionbox-tangshi-num {
  color: #000;
  padding-left: 30rpx;
}
/* 桌号字体 */
.optionbox-tangshi-num text {
  color: #c29666;
  font-size: 16px;
}

.optionbox-ziqu {
  display: flex;
  justify-content: flex-end;
  padding-right: 20rpx;
}
```

css

```
 onLoad: function (options) {
    // 获取桌号
    console.log('options',options)
    // 如果有桌号，则存桌号
    if (options.desk) {
      app.globalData.deskNum = options.desk
    }
  },

    onShow: function () {
    //判断食堂食还是自取
    this.setData({
      index: app.globalData.changeIndex,
      deskNum: app.globalData.deskNum
    });
  },

  // 输入框搜索模块的实现
  searchValue(e) {
    let val = e.detail.value
    let data = []
    if (val !== '') {
      data = this.data.cacheCategory.filter(item => {
        return item.category.name.includes(val)
      })
    } else {
      data = this.data.cacheCategory
    }
    this.setData({
      category: data
    })
    console.log(this.data.category);
  }
```

js

此处只列举一个

关于购物车支付页面
添加了一个 picker 组件 用于取餐时间的设置 此处直接参考的官方文档设计

1010
今天发工资啦 1k 前端第一桶金 支付宝存了 700 微信 300 微信用来吃饭哈哈
然后 今天主要还是在修改小程序 主要在搞他发布上线 很多问题
然后 了解到 develop 开发环境 和 prod 生产环境 的区别 算是搞明白了

1011
今天主要在发布小程序 1.1 版本 各种问题 还没发布成功 然后 二维码申请那块也有问题存在 希望明天能解决

1012
今天基于昨天发布微信小程序版本不通过的问题 微信审核不允许进入小程序直接授权用户登录 对此需要进行调整

1013 没有谁的生活会一直完美 满怀希望就能所向披靡 丞哥 bless me
没有谁会一直靠得住 我只能靠自己 实现达到自己想要的一切
小程序 全局路由拦截 那块卡了几天 发布上线也在卡着 今天的新任务是下拉刷新更新订单页 没有谁有义务一直帮我做什么 靠自己嗷 加油 我可以的

现在是下午三点 实现了
需要添加的下拉刷新 静态的购物车 简单判断 若没有则提示空空如也 订单页也添加了提示
问题： 小程序路由拦截那块 目前还不能正确实现不登录加入购物车等功能 控制台还是会报错

需要添加地址图标呜呜呜 又给自己找了事情
基本完成

听了黑马 pink 的直播 我觉得我拿 14k 也没得问题 性能优化 项目规模 封装通用组件方便他人合作

1014
在用户没有登录的情况下 前端进行存储数据 对数据进行增删改操作
下拉刷新获取最新订单做了一层判断 不会导致请求两次数据

在 app.js 里定义全局变量 shopping: []
需要在这里对数据进行增删改操作

```
//添加到购物车
  addToCart: function () {
    console.log(this.data);
    if (wx.getStorageSync('userId')) {
      util.request(api.AddCart + '?userId=' + wx.getStorageSync('userId'), {
        foodsId: this.data.info.id,
        quantity: this.data.number,
        foodsProductId: this.data.guigeId,
        attributes: this.data.attribute,
        isCombo: this.data.info.isCombo
      }, "POST")
      .then(function (res) {
        // console.log("添加", res);
        if (res.errno == 0) {
          wx.showToast({
            title: '添加成功'
          });
        } else {
          wx.showToast({
            title: res.errmsg,
            icon: "none"
          });
        }
        setTimeout(function () {
          wx.navigateBack({
            delta: 1,
          })
        }, 500)
      }, res => {
        // console.log(res);
      });
    } else {
      console.log('存入前端缓存');
      console.log(this.globalData.shopping);
    }

  },

```

下拉刷新用户订单数据

```
beforeOnRefresh: function() {
     //导航条加载动画
     wx.showNavigationBarLoading()
     //loading 提示框
     wx.showLoading({
       title: 'Loading...',
     })
  },
  closeOnRefresh: function() {
    wx.hideLoading();
    wx.hideNavigationBarLoading();
    //停止下拉刷新
    wx.stopPullDownRefresh();
  },
  /**
   * 页面相关事件处理函数--监听用户下拉动作
   */
  onPullDownRefresh:function(){
    this.beforeOnRefresh()
    if (this.data.current === 0) {
      this.getOrderInfo();
    } else {
      this.getGoodsOrderInfo();
    }
  },

```

还是需要 setTimeout(函数,2000)来调用结束的回调函数 setTimeout 里面 this 指向问题 ...

```
/**
  * 页面相关事件处理函数--监听用户下拉动作
  */
 onPullDownRefresh:function(){
   let that = this;
   this.beforeOnRefresh()
   if (this.data.current === 0) {
     this.getOrderInfo();
    //  this.closeOnRefresh();
    setTimeout(function(){
      that.closeOnRefresh()
    }, 1000)
   } else {
     this.getGoodsOrderInfo();
    setTimeout(function(){
      that.closeOnRefresh()
    }, 1000)
   }
 },
```

1017
支付接口对接 支付接口基本修改完 我觉得很烦真的 好难
ui 设计图修改
未登录状态下正常加入购物车

1.未登录 结算时需要判断是否登录 没登录跳转登录页

2.加入购物车 加入哪些数据？ 怎么样算添加成功
菜品名 数量 单价 图片

1018 配置小程序点击跳转遇到的问题：

```
navigateTo路由跳转方式可以实现历史回退
其他路由的一些简单介绍：

wx.navigateTo() 带历史回退,不能跳转到tabbar页面

wx.redirectTo() 不保留历史，跳转到另一个页面，不能返回到上一页面
//相当于vue中的路由跳转方式this.$router.replace()

wx.switchTab() 只跳转到tabBar页面，不带回退

wx.reLaunch() 即能跳转到tabBar页面，也能跳转到非tabBar页面，不带历史回退
```

退款接口调整&小程序页面优化

1019
今天写了一天 没登录状态加入购物车 还没完全实现

```
  // 获取用户登录信息
  // getUserInfo:function () {
  //   // 判断当前用户是否微信授权
  //   if (app.globalData.userInfo.avatar == null) {
  //     wx.showModal({
  //       content: '您还未授权',
  //       confirmText: '去授权',
  //       success(res) {
  //         if (res.confirm) {
  //           wx.showToast({
  //             title: '请登录后添加购物车',
  //             icon: "none",
  //             duration: 2000
  //           })
  //         }
  //       }
  //     })
  //     return
  //   }
  // },

  //添加到购物车
  // addToCart: function () {
  //   util.request(api.AddCart + '?userId=' + wx.getStorageSync('userId'), {
  //       foodsId: this.data.info.id,
  //       quantity: this.data.number,
  //       foodsProductId: this.data.guigeId,
  //       attributes: this.data.attribute,
  //       isCombo: this.data.info.isCombo
  //     }, "POST")
  //     .then(function (res) {
  //       // console.log("添加", res);
  //       if (res.errno == 0) {
  //         wx.showToast({
  //           title: '添加成功'
  //         });
  //       } else {
  //         wx.showToast({
  //           title: res.errmsg,
  //           icon: "none"
  //         });
  //       }
  //       setTimeout(function () {
  //         wx.navigateBack({
  //           delta: 1,
  //         })
  //       }, 500)
  //     }, res => {
  //       // console.log(res);
  //     });
  // },
```

```
//总价格
            // let toPrice = cartArray.map((item,index) => {
            //   return item.minPrice * item.quantity
            // })
            // // console.log(toPrice,'多件商品总价格');
            // let totPrice = 0
            // for ( let i = 0; i<newTotal.length;i++) {
            //   totPrice += toPrice[i];
            // }
            // console.log(totPrice,'多件商品总价格1111111111');

```

```
newCart.js
 onShow: function () {
    this.getCart();
    // console.log(app.globalData.changeIndex);

  // const self = this;
  // // 未登录状态下购物车里的数据
  // wx.getStorage({
  //   key:'cartInfo',
  //   encrypt: true, // 若开启加密存储，setStorage 和 getStorage 需要同时声明 encrypt 的值为 true
  //   success(res){
  //     const cartList = res.data;                 //缓存里面的数据
  //     console.log(cartList,'缓存中的购物车数据');
  //     let newTotal =  cartList.map(item => item.quantity);
  //     let price =  cartList.map(item => item.quantity*item.minPrice);
  //     let total = 0; let totalPrice = 0;
  //     for ( let i = 0; i<cartList.length;i++) {
  //           total += newTotal[i];
  //           totalPrice +=  price[i];
  //     }
  //     self.setData({
  //       // cartList:cartList,
  //       cartList:res.data,
  //       name:cartList.name,
  //       minPrice:cartList.minPrice,
  //       totalPrice:totalPrice,
  //     })

  //   },
  //   fail(){

  //   }
  // })
  },

```

1021
软件项目管理实验报告提上日程
没搞完的项目得继续搞完 然后提交什么的
21 号挺忙的其实 代码没搞什么
早上拍毕业生信息采集照
下午两点开了个简短的会议 两周一次 biweekly 说一说你这两周的感觉什么的
然后四点周会总结 还演示了微信小程序代码
然后 关于微信小程序 目前有个小想法
能不能把未登录缓存封装一个函数 需要调用的地方去调用
然后就是 需要在用户登录之后 push 进去缓存中的数据 还有就是需要设置缓存过期时间
那么就得确保那些需要展示的变量名一致 才可以尽量少的进行修改

1022
商品那块 UI 也需要做一个调整 但是优先级不是很高
还是需要先解决逻辑

先不想封装的问题 先解决页面问题 是在不行就是重复代码过得 这个那就没办法

没有用的代码 我感觉我在造一堆没什么用的东西

```
// 所有商品总数量
          //  let newTotal =  cartList.map(item => item.quantity)
          //   // console.log(newTotal,'总数量数组');
          //   let total = 0;
          //   for ( let i = 0; i<newTotal.length;i++) {
          //     total += newTotal[i];
          //   }
          //   wx.setStorage({
          //     data:total,
          //     key:'alltotal'
          //   })

```

遇到点问题
准备在本地缓存中存两个东西 一个 list 数组 存全部信息 为了能够遍历出规格信息
一个 info 数组 到时候好操作加减
然后现在同时添加两个之后 不能一次加入多个数据 不知道哪的问题

然后关于加入购物车 里面删减数据的 bug 这个调整真的难受 ctmd
还有就是用户登录之后得先获取一遍本地缓存中的数据 然后还需要发一次请求 获取服务器里面的数据
今天脑袋不清楚了 明天再写吧
